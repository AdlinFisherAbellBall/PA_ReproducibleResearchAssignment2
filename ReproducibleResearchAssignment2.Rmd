---
title: "ReproducibleResearchAssignment2"
author: "CrankyKookyCorvids"
date: "2023-06-10"
output: html_document
---

```{r}
library(ggplot2)
damage = read.csv(bzfile("repdata_data_StormData.csv.bz2"))
damage$BGN_DATE = strptime(damage$BGN_DATE, tz='', '%m/%d/%Y %H:%M:%OS')
damage30 = damage[damage$BGN_DATE > strptime('1981-11-01', '%Y-%m-%d'),
                  1:length(colnames(damage))]
columns = c('BGN_DATE', 'PROPDMG', 'PROPDMGEXP', 'CROPDMG', 'CROPDMGEXP', 'EVTYPE')
QuantDam = damage30[columns]
QuantDam = QuantDam[(QuantDam$PROPDMG == 0)|
                      (QuantDam$PROPDMGEXP %in% c('K', 'M', 'B', '')), 
                    1:length(colnames(QuantDam)) ]
QuantDam = QuantDam[(QuantDam$CROPDMG == 0)|
                      (QuantDam$CROPDMGEXP %in% c('K', 'M', 'B', '')), 
                    1:length(colnames(QuantDam)) ]

totaldamage = rep(0, dim(QuantDam)[1])
ttldmg2023 = rep(0, dim(QuantDam)[1])

pks = (QuantDam$PROPDMGEXP == 'K' | QuantDam$PROPDMGEXP == 'k')
totaldamage = totaldamage + QuantDam$PROPDMG * pks * 10^3
remove(pks)

pms = (QuantDam$PROPDMGEXP == 'M')
totaldamage = totaldamage + QuantDam$PROPDMG * pms * 10^6
remove(pms)

pbs = (QuantDam$PROPDMGEXP == 'B')
totaldamage = totaldamage + QuantDam$PROPDMG * pbs * 10^9
remove(pbs)

cks = (QuantDam$CROPDMGEXP == 'K' | QuantDam$CROPDMGEXP == 'k')
totaldamage = totaldamage + QuantDam$CROPDMG * cks * 10^3
remove(cks)

cms = (QuantDam$CROPDMGEXP == 'M')
totaldamage = totaldamage + QuantDam$CROPDMG * cms * 10^6
remove(cms)

cbs = (QuantDam$CROPDMGEXP == 'B')
totaldamage = totaldamage + QuantDam$CROPDMG * cbs * 10^9
remove(cbs)

eventCPI = rep(0, dim(QuantDam)[1])


ttldmg2023 = rep(0, dim(QuantDam)[1])

QuantDam = cbind(QuantDam, TOTALDMG = totaldamage)
CPI = read.csv('CPI.csv')

CPI$Label = strptime(paste(CPI$Label, '01'), '%Y %b %d')
CPIperiod = strptime(paste(format(QuantDam$BGN_DATE, "%Y-%m"), '01', sep= '-'), format = '%Y-%m-%d')
periodind = match(CPIperiod, CPI$Label)
for (i in 1:length(CPIperiod)) {
  eventCPI[i] = CPI$Value[periodind[i]]
}
remove(CPIperiod, periodind)

NowCPI = CPI$Value[match(strptime('2023-05-01', '%Y-%m-%d'), CPI$Label)]
ttldmg2023 = (NowCPI/eventCPI) * totaldamage
QuantDam = cbind(QuantDam, TOTAL2023DMG = as.numeric(ttldmg2023))
hurricanelabels = c('HURRICANE OPAL', 'HURRICANE OPAL/HIGH WINDS',
                    'HURRICANE ERIN', 'HURRICANE EMILY', 'TYPHOON',
                    'HURRICANE')
QuantDam$EVTYPE[QuantDam$EVTYPE %in% hurricanelabels] = 'HURRICANE/TYPHOON'
QuantDam$EVTYPE[QuantDam$EVTYPE == 'Damaging Freeze'] = 'DAMAGING FREEZE'
QuantDam$EVTYPE[QuantDam$EVTYPE == 'River Flooding'] = 'RIVER FLOOD'
QuantDam$EVTYPE[QuantDam$EVTYPE == 'STORM SURGE/TIDE'] = 'STORM SURGE'
QuantDam$EVTYPE[QuantDam$EVTYPE == 'FLASH FLOOD/FLOOD'] = 'MAJOR FLOOD'

df = data.frame(EVTYPE = QuantDam$EVTYPE, DMG = as.numeric(QuantDam$TOTAL2023DMG))
totaldamages = aggregate(df$DMG, list(df$EVTYPE), FUN = sum)
sumind = order(totaldamages$x, decreasing = TRUE)
df = cbind(df$EVTYPE[sumind], df$DMG[sumind])
df = data.frame(EVENT = meandamages[1:15, 1], 
                AVEDMG = as.numeric(meandamages[1:15, 2]))

QuantDam1 = QuantDam[QuantDam$EVTYPE %in% df$EVENT, ]
ggplot(data = QuantDam1) +
  geom_boxplot(mapping = aes(EVTYPE, TOTAL2023DMG, fill = EVTYPE)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  scale_fill_viridis_d(option = "F") +
  scale_y_log10(name = "Average Damage \n (Dollars as of May, 2023)")
```

